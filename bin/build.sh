#!/bin/bash -e
DIR=$(dirname "$(readlink -f "$0")")
cd ${DIR}/..
DIR=$(pwd)
PATH=${DIR}/node_modules/.bin:${PATH}
cd ${DIR}/src
find */ -type d | sort |
while read dirname
do
  cd ${DIR}/src/${dirname}
  echo "// This file will be overwritten.  It was generated by build.sh." > index.ts
  echo "" >> index.ts

  find . -mindepth 1 -maxdepth 1 -type d | sort |
  while read curdir
  do
    curdirbase=$(basename ${curdir})
    echo "export * as ${curdirbase} from '${curdir}';" >> index.ts
  done

  ls *.ts |grep -v index.ts | sort |
  while read curfile
  do
    curfilebase=$(basename ${curfile} .ts)
    echo "export * as ${curfilebase} from './${curfilebase}';" >> index.ts
  done
done
#export NODE_OPTIONS="--max-old-space-size=$(${DIR}/bin/free.sh | awk '{print int($1*0.9)}')"
#unset NODE_OPTIONS
time tsc && echo "Build Complete"
